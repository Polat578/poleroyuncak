<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Poler Oyuncak — Kartvizit Tara</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root { --bg:#0b1220; --fg:#eaf2ff; --muted:#9fb3c8; --brand:#0ea5e9; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;gap:8px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}
    main{max-width:960px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    video,canvas,img{width:100%;border-radius:12px;background:#000}
    button{appearance:none;border:0;background:var(--brand);color:#001018;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.2)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.03);color:var(--fg)}
    textarea{min-height:92px;resize:vertical}
    .hint{color:var(--muted);font-size:13px}
    .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}

    /* ====== Logo overlay & animasyon ====== */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(11,18,32,0.85); z-index:9999; transition:opacity .25s ease;
    }
    .overlay.hidden{opacity:0; pointer-events:none}
    .logo-wrap{display:flex; flex-direction:column; align-items:center; gap:12px}
    .logo{
      width:140px; height:140px; object-fit:contain;
      /* boşta hafif nefes alma */
      animation: idlePulse 2s ease-in-out infinite;
      filter:blur(1.2px) brightness(1.1);
      opacity:.85;
    }
    /* OCR sırasında net–soluk döngüsü */
    .logo.loading{
      animation: breatheSharp 1.2s ease-in-out infinite;
    }
    @keyframes idlePulse{
      0%{opacity:.75} 50%{opacity:1} 100%{opacity:.75}
    }
    @keyframes breatheSharp{
      0%  { opacity:.45; filter:blur(1.8px) brightness(1.15); }
      50% { opacity:1;   filter:blur(0.2px) brightness(1.0);  }
      100%{ opacity:.45; filter:blur(1.8px) brightness(1.15); }
    }
  </style>
</head>
<body>
  <!-- Bekleme/Çalışıyor overlay (logo) -->
  <div id="overlay" class="overlay">
    <div class="logo-wrap">
      <!-- logoyu /buying/logso.png olarak koy -->
      <img id="brandLogo" class="logo" src="logso.png" alt="Poler Oyuncak" />
      <div class="hint" id="overlayHint">Hazır… Kamerayı açabilir veya fotoğraf yükleyebilirsin.</div>
    </div>
  </div>

  <header>
    <h1>Poler Oyuncak • Kartvizit Tara</h1>
    <span class="hint">/buying</span>
  </header>

  <main>
    <div class="grid">
      <!-- Kamera & Çekim -->
      <section class="card">
        <h2 style="margin:0 0 8px 0">1) Kartviziti Tara</h2>
        <p class="hint" id="permHint">Kamera izni isteyeceğiz. Işık iyi olsun, kart kadrajı doldursun.</p>
        <div class="row">
          <button id="btnStart">Kamerayı Aç</button>
          <button id="btnCapture" class="ghost" disabled>Fotoğraf Çek</button>
          <button id="btnRetake" class="ghost" disabled>Tekrar Çek</button>
        </div>
        <div style="margin-top:10px">
          <video id="video" playsinline muted></video>
          <canvas id="canvas" style="display:none"></canvas>
          <img id="preview" alt="Önizleme" style="display:none"/>
          <!-- Fallback için gizli file input -->
          <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none" />
        </div>
        <p class="hint mono" id="camLog"></p>
      </section>

      <!-- Form & OCR -->
      <section class="card">
        <h2 style="margin:0 0 8px 0">2) Kontrol Et & Kaydet</h2>
        <p class="hint">OCR otomatik doldurur; gerekirse düzelt.</p>

        <div class="row" style="gap:12px">
          <div style="flex:1">
            <label for="name">Şirket Adı</label>
            <input id="name" placeholder="Örn: Poler Oyuncak A.Ş." />
          </div>
          <div style="width:240px;max-width:100%">
            <label for="phone">Telefon</label>
            <input id="phone" placeholder="+90 5xx xxx xx xx" />
          </div>
        </div>

        <div class="row" style="gap:12px;margin-top:8px">
          <div style="flex:1">
            <label for="email">E-posta</label>
            <input id="email" placeholder="info@..." />
          </div>
          <div style="flex:1">
            <label for="address">Adres</label>
            <input id="address" placeholder="Mah., Cad., No, İl/İlçe..." />
          </div>
        </div>

        <div class="row" style="gap:12px;margin-top:8px">
          <div style="flex:1">
            <label for="contact">İlgili Kişi</label>
            <input id="contact" placeholder="Ad Soyad / Ünvan" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnOcr" class="ghost" disabled>OCR ile Doldur</button>
          <button id="btnSave" disabled>Kaydet</button>
          <span id="saveMsg" class="hint"></span>
        </div>

        <details style="margin-top:12px">
          <summary class="hint">OCR ham metni göster</summary>
          <pre id="rawText" class="mono" style="white-space:pre-wrap"></pre>
        </details>
      </section>
    </div>
  </main>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- Firebase (compat SDK'ler – vanilla JS için basit) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>

  <script>
  // --------- Firebase Config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD4MPM2fvkTXeOWG12g-wV_s3eG4SkBWS0",
    authDomain: "poleroyuncak.firebaseapp.com",
    projectId: "poleroyuncak",
    storageBucket: "poleroyuncak.appspot.com",
    messagingSenderId: "473844630811",
    appId: "1:473844630811:web:721ebd8a9b6f085da03fbe",
    measurementId: "G-JNQTNX3EC4"
  };
  // ------------------------------------

  let app, auth, db, storage, uid = null;
  try {
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    storage = firebase.storage();
    auth.onAuthStateChanged(async (u) => {
      if (!u) await auth.signInAnonymously();
      uid = (auth.currentUser || u).uid;
      document.getElementById('btnSave').disabled = false;
    });
  } catch (e) {
    console.warn("Firebase init edilemedi:", e);
  }

  const overlay = document.getElementById('overlay');
  const brandLogo = document.getElementById('brandLogo');
  const overlayHint = document.getElementById('overlayHint');

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const preview = document.getElementById('preview');
  const fileInput = document.getElementById('fileInput');

  const btnStart = document.getElementById('btnStart');
  const btnCapture = document.getElementById('btnCapture');
  const btnRetake = document.getElementById('btnRetake');
  const btnOcr = document.getElementById('btnOcr');
  const btnSave = document.getElementById('btnSave');

  const camLog = document.getElementById('camLog');
  const rawText = document.getElementById('rawText');
  const saveMsg = document.getElementById('saveMsg');

  const $ = (id) => document.getElementById(id);
  const fields = { name: $('name'), phone: $('phone'), email: $('email'), address: $('address'), contact: $('contact') };

  let stream = null, lastImageBlob = null, ocrText = "";

  /* -------- Normalizasyon & Yakalama -------- */
  function normalizeOCRText(s) {
    if (!s) return "";
    return s
      .replace(/[\u2010-\u2014]/g, "-").replace(/[“”„"]/g, '"').replace(/[’‘']/g, "'")
      .replace(/\(at\)|\sat\s/gi, "@").replace(/\s*\[at\]\s*/gi, "@")
      .replace(/\(dot\)|\sdot\s/gi, ".").replace(/\s*\[dot\]\s*/gi, ".")
      .replace(/(\w),(\w)/g, "$1.$2")
      .replace(/(\S)@(\s+)/g, "$1@").replace(/(\s+)@(\S)/g, "@$2")
      .replace(/(?<=\w)0(?=\w)/g, "O").replace(/(?<=\b)O(?=\d)/g, "0")
      .replace(/I(?=\d)/g, "1").replace(/l(?=\d)/g, "1");
  }
  function findEmails(text) {
    const t = normalizeOCRText(text||"");
    const re = /[A-Z0-9._%+-]+(?:\s*@\s*|@)[A-Z0-9.-]+(?:\s*\.\s*|\.)[A-Z]{2,}/gi;
    const out = (t.match(re) || []).map(e => e.replace(/\s*@\s*/g,"@").replace(/\s*\.\s*/g,"."));
    return [...new Set(out)];
  }
  function findPhones(text) {
    let t = normalizeOCRText(text||"");
    const re = /(?:\+?90[\s\-\.]?)?(?:0[\s\-\.]?)?(?:\(?\d{3}\)?[\s\-\.]?)\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}/g;
    const cand = t.match(re) || [];
    const cleaned = cand.map(x => x.replace(/[^\d+]/g, ""));
    const valid = cleaned.filter(num => { const d=num.replace(/\D/g,""); return d.length>=10 && d.length<=12; });
    const scored = valid.map(v=>{ const d=v.replace(/\D/g,""); let s=d.length; if (/^\+?90/.test(v)||/^0?5\d{2}/.test(v)) s+=5; return {v,s}; }).sort((a,b)=>b.s-a.s);
    return scored.map(x=>x.v);
  }
  function findAddressLine(text) {
    const lines = (text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    return lines.find(l =>
      /mah\.|mh\.|cad\.|cd\.|sok\.|sk\.|no[:\s]|ilçe|istanbul|ankara|izmir|bursa|kocaeli|antalya|adana|konya|gaziantep|kayseri|mersin|eskişehir/i.test(l)
    ) || "";
  }
  function pickBestEmail(emails) {
    if (!emails.length) return "";
    emails.sort((a,b)=>{ const sc=e=>(/\.com(\.tr)?$/i.test(e)?2:0)+(/@[a-z0-9\-]+/i.test(e)?1:0); return sc(b)-sc(a); });
    return emails[0];
  }
  function pickBestPhone(phones) {
    if (!phones.length) return "";
    phones.sort((a,b)=>{ const da=a.replace(/\D/g,"").length, db=b.replace(/\D/g,"").length; const pa=(/^\+?90/.test(a)||/^0?5/.test(a))?2:0; const pb=(/^\+?90/.test(b)||/^0?5/.test(b))?2:0; return (db+pb)-(da+pa); });
    const d = phones[0].replace(/\D/g,""); let out=d;
    if (d.length===12 && d.startsWith("90")) out=d.slice(2);
    if (out.length===11 && out.startsWith("0")) out=out.slice(1);
    if (out.length===10) return `0${out.slice(0,3)} ${out.slice(3,6)} ${out.slice(6,8)} ${out.slice(8,10)}`;
    return phones[0];
  }

  /* -------- Görüntü ön-işleme / ölçekleme / 180° -------- */
  async function preprocessForOCR(blob) {
    const img = await createImageBitmap(blob);
    const off = document.createElement('canvas');
    off.width = img.width; off.height = img.height;
    const ctx = off.getContext('2d');

    // grayscale
    ctx.drawImage(img, 0, 0);
    let d = ctx.getImageData(0, 0, off.width, off.height);
    let px = d.data;
    for (let i=0;i<px.length;i+=4){ const r=px[i],g=px[i+1],b=px[i+2]; const y=0.299*r+0.587*g+0.114*b; px[i]=px[i+1]=px[i+2]=y; }
    ctx.putImageData(d,0,0);

    // contrast + gamma
    d=ctx.getImageData(0,0,off.width,off.height); px=d.data;
    const contrast=1.25, gamma=0.9;
    for (let i=0;i<px.length;i+=4){ let v=px[i]/255; v=Math.pow(v,gamma); v=(v-0.5)*contrast+0.5; v=Math.max(0,Math.min(1,v)); const u=v*255|0; px[i]=px[i+1]=px[i+2]=u; }
    ctx.putImageData(d,0,0);

    // simple adaptive threshold
    const block=Math.max(15,Math.round(Math.min(off.width,off.height)/40));
    const rad=block|0;
    d=ctx.getImageData(0,0,off.width,off.height); px=d.data;
    for (let y=0;y<off.height;y++){
      for (let x=0;x<off.width;x++){
        let sum=0,cnt=0;
        for (let yy=y-rad;yy<=y+rad;yy+=rad){
          if (yy<0||yy>=off.height) continue;
          for (let xx=x-rad;xx<=x+rad;xx+=rad){
            if (xx<0||xx>=off.width) continue;
            const idx=(yy*off.width+xx)*4; sum+=px[idx]; cnt++;
          }
        }
        const idx=(y*off.width+x)*4; const mean=sum/(cnt||1);
        const val=px[idx] < (mean-8) ? 0 : 255;
        px[idx]=px[idx+1]=px[idx+2]=val;
      }
    }
    ctx.putImageData(d,0,0);

    return await new Promise(res=>off.toBlob(res,'image/png',1.0));
  }
  async function scaleBlob(blob,factor=1.6){
    const bmp=await createImageBitmap(blob);
    const c=document.createElement('canvas'); c.width=Math.round(bmp.width*factor); c.height=Math.round(bmp.height*factor);
    const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
    ctx.drawImage(bmp,0,0,c.width,c.height);
    return await new Promise(res=>c.toBlob(res,'image/jpeg',0.95));
  }
  async function rotateBlob180(blob){
    const bmp=await createImageBitmap(blob);
    const c=document.createElement('canvas'); c.width=bmp.width; c.height=bmp.height;
    const ctx=c.getContext('2d'); ctx.translate(c.width,c.height); ctx.rotate(Math.PI); ctx.drawImage(bmp,0,0);
    return await new Promise(res=>c.toBlob(res,'image/jpeg',0.95));
  }

  /* -------- Akıllı isim & ilgili kişi -------- */
  function pickCompanyNameSmart(ocrData) {
    const lines = ocrData?.lines || [];
    if (!lines.length) return null;
    function scoreLine(L){
      const text=(L.text||"").trim(); if (!text) return -1e9;
      const hasDigit=/\d/.test(text);
      const {x0=0,y0=0,x1=0,y1=0}=L.bbox||{}; const h=Math.max(1,(y1-y0)); const yTop=y0;
      const allCaps = text===text.toUpperCase() && /[A-ZÇĞİÖŞÜ]/.test(text);
      const reasonable = text.length>=2 && text.length<=32;
      const brandy = /\b(ltd|anonim|a\.ş|aş|inc|ltd\.|limited|holding|oyuncak|plastic|gıda|tekstil)\b/i.test(text);
      let s=0; s+=(1000-Math.min(1000,yTop)); s+=h*2;
      if(!hasDigit) s+=80; if(allCaps) s+=60; if(reasonable) s+=50; if(brandy) s+=40;
      if(/@/.test(text)||/(mah\.|cad\.|sok\.|no[:\s]|istanbul|ankara|izmir|bursa|kocaeli|antalya|adana|konya|gaziantep|kayseri|mersin|eskişehir)/i.test(text)||/(\+?90|0?\s?5\d{2})/.test(text)) s-=200;
      let avg=0,c=0; (L.words||[]).forEach(w=>{ if(typeof w.confidence==='number'){avg+=w.confidence;c++;}});
      if(c) s+=(avg/c); if(text.length>40) s-=60; return s;
    }
    const scored=(lines.map(L=>({text:(L.text||"").trim(),score:scoreLine(L)})).filter(x=>x.text)).sort((a,b)=>b.score-a.score);
    return scored[0]?.text||null;
  }

  function looksLikePersonName(line){
    if (!line || /[@\d]/.test(line)) return false;
    const parts=line.trim().split(/\s+/);
    if (parts.length<2 || parts.length>4) return false;
    return parts.every(p => /^[A-ZÇĞİİÖŞÜ][a-zçğıiöşü'-]+$/.test(p));
  }

  function pickContactPerson(ocrData, fullText){
    const keywords = /(ilgili|iletişim|contact|satış|sales|pazarlama|marketing|müdür|manager|owner|kurucu|genel müdür|director|representative|temsilci)/i;
    const linesData = ocrData?.lines || [];
    const byKW = linesData.map(l => (l.text||"").trim()).filter(t => keywords.test(t));
    for (const t of byKW){
      const cand = t.replace(keywords, '').trim();
      if (looksLikePersonName(cand)) return cand;
    }
    for (let i=0;i<linesData.length;i++){
      const t=(linesData[i].text||"").trim();
      if (keywords.test(t)){
        const prev=(linesData[i-1]?.text||"").trim();
        const next=(linesData[i+1]?.text||"").trim();
        if (looksLikePersonName(prev)) return prev;
        if (looksLikePersonName(next)) return next;
      }
    }
    const plain = (fullText||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    for (const l of plain){
      if (looksLikePersonName(l) && !/@/.test(l) && !/\d/.test(l) &&
          !/(mah\.|cad\.|sok\.|no[:\s]|istanbul|ankara|izmir|bursa|kocaeli|antalya|adana|konya|gaziantep|kayseri|mersin|eskişehir)/i.test(l)) {
        return l;
      }
    }
    return "";
  }

  /* -------- Single & Multi-pass OCR -------- */
  async function ocrOnce(blob, logger){ const {data}=await Tesseract.recognize(blob,'tur+eng',{logger}); return data; }
  async function ocrMultiPass(blob, logger){
    const texts=[]; const datas=[];
    const d1=await ocrOnce(blob,logger); texts.push(d1.text||""); datas.push(d1);
    try{ const pre=await preprocessForOCR(blob); const d2=await ocrOnce(pre,logger); texts.push(d2.text||""); datas.push(d2);}catch{}
    try{ const big=await scaleBlob(blob,1.6); const d3=await ocrOnce(big,logger); texts.push(d3.text||""); datas.push(d3);}catch{}
    if ((texts.join("\n").trim().length < 30)) {
      try{ const r=await rotateBlob180(blob); const d4=await ocrOnce(r,logger); texts.push(d4.text||""); datas.push(d4);}catch{}
    }
    const fullText = texts.map(t=>normalizeOCRText(t)).join("\n");
    const bestData = datas.sort((a,b)=>(b.lines?.length||0)-(a.lines?.length||0))[0] || d1;
    return { fullText, bestData };
  }

  /* -------- Fallback: Dosya girişi -------- */
  function useFileCaptureFallback(openPicker = false) {
    btnCapture.disabled = false;
    btnRetake.disabled = true;
    btnOcr.disabled = true;

    video.style.display = 'none';
    preview.style.display = 'none';

    fileInput.onchange = () => {
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        lastImageBlob = file;
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
        btnRetake.disabled = false;
        btnOcr.disabled = false;
        camLog.textContent = "Fotoğraf yüklendi. OCR için hazır.";
        overlay.classList.add('hidden');
      }
    };

    if (openPicker) fileInput.click();
    else camLog.innerHTML += ' <span class="hint">(“Fotoğraf Çek”e basınca kamera/galeri açılır.)</span>';
  }

  /* -------- Kamera aç -------- */
  btnStart.onclick = async () => {
    try {
      if (location.protocol !== 'https:') {
        camLog.innerHTML = '<span class="err">HTTPS gerekli. Sayfayı https:// ile aç.</span>';
        return useFileCaptureFallback();
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        camLog.innerHTML = '<span class="warn">Tarayıcı kamera API’sını desteklemiyor, fotoğraf yükleme moduna geçildi.</span>';
        return useFileCaptureFallback();
      }
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false
      });
      video.srcObject = stream;
      video.setAttribute('playsinline','true');
      video.muted = true;
      await video.play();

      btnCapture.disabled = false;
      btnRetake.disabled = true;
      btnOcr.disabled = true;

      preview.style.display = 'none';
      canvas.style.display = 'none';
      video.style.display = 'block';
      camLog.textContent = "Kamera aktif.";
      overlay.classList.add('hidden'); // kamera açıldıysa bekleme kalksın
    } catch (err) {
      camLog.innerHTML = `Kamera açılamadı: <span class="err">${err.message||err.name||'hata'}</span> — fotoğraf yükleme moduna geçiliyor.`;
      useFileCaptureFallback();
    }
  };

  /* -------- Fotoğraf çek -------- */
  btnCapture.onclick = async () => {
    if (!stream || !video.videoWidth) return useFileCaptureFallback(true);

    const w = video.videoWidth, h = video.videoHeight;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    canvas.toBlob((blob) => {
      if (!blob) return;
      lastImageBlob = blob;
      preview.src = URL.createObjectURL(blob);
      preview.style.display = 'block';
      video.style.display = 'none';
      canvas.style.display = 'none';
      btnRetake.disabled = false;
      btnOcr.disabled = false;
      camLog.textContent = "Fotoğraf alındı. OCR için hazır.";
    }, 'image/jpeg', 0.92);
  };

  /* -------- Tekrar çek -------- */
  btnRetake.onclick = () => {
    preview.style.display = 'none';
    if (stream) {
      video.style.display = 'block';
      btnOcr.disabled = true;
      camLog.textContent = "Tekrar çekebilirsiniz.";
    } else {
      fileInput.value = '';
      lastImageBlob = null;
      btnOcr.disabled = true;
      camLog.textContent = "Tekrar fotoğraf seçebilirsiniz.";
    }
  };

  /* -------- OCR (multi-pass) + net–soluk logo -------- */
  btnOcr.onclick = async () => {
    if (!lastImageBlob) return;
    btnOcr.disabled = true; btnOcr.textContent = "OCR çalışıyor...";
    // overlay açık, logo “loading” modunda net–soluk döngüsü
    overlayHint.textContent = "OCR çalışıyor…";
    brandLogo.classList.add('loading');
    overlay.classList.remove('hidden');

    try {
      const { fullText, bestData } = await ocrMultiPass(lastImageBlob, m => {
        camLog.textContent = `OCR: ${m.status} ${Math.round((m.progress||0)*100)}%`;
      });

      ocrText = fullText.trim();
      rawText.textContent = ocrText || "(metin bulunamadı)";

      const emails = findEmails(ocrText);
      const phones = findPhones(ocrText);
      const address = findAddressLine(ocrText);
      const nameSmart = pickCompanyNameSmart(bestData);
      const contactSmart = pickContactPerson(bestData, ocrText);

      if (nameSmart) fields.name.value = nameSmart;
      if (!fields.email.value) fields.email.value = pickBestEmail(emails);
      if (!fields.phone.value) fields.phone.value = pickBestPhone(phones);
      if (!fields.address.value) fields.address.value = address;
      if (!fields.contact.value) fields.contact.value = contactSmart;

      btnSave.disabled = false;
      camLog.innerHTML = `OCR tamam: <span class="ok">alanlar dolduruldu</span>`;
    } catch (e) {
      camLog.innerHTML = `OCR hata: <span class="err">` + e.message + `</span>`;
    } finally {
      btnOcr.textContent = "OCR ile Doldur";
      btnOcr.disabled = false;
      // Yükleme bitti → overlay kapanır, logo idle moda döner
      brandLogo.classList.remove('loading');
      overlay.classList.add('hidden');
      overlayHint.textContent = "Hazır… Kamerayı açabilir veya fotoğraf yükleyebilirsin.";
    }
  };

  /* -------- Kaydet (Firestore + Storage) -------- */
  btnSave.onclick = async () => {
    if (!db || !storage || !uid) { saveMsg.innerHTML = '<span class="warn">Firebase yapılandır.</span>'; return; }
    if (!fields.name.value.trim()) { saveMsg.innerHTML = '<span class="warn">Şirket adı zorunlu.</span>'; return; }
    btnSave.disabled = true; saveMsg.textContent = "Kaydediliyor...";

    try {
      let imageUrl = null;
      if (lastImageBlob) {
        const key = `cards/${uid}/${crypto.randomUUID()}.jpg`;
        const ref = storage.ref().child(key);
        await ref.put(lastImageBlob, { contentType: 'image/jpeg' });
        imageUrl = await ref.getDownloadURL();
      }

      const doc = {
        name: fields.name.value.trim(),
        phone: fields.phone.value.trim() || null,
        email: fields.email.value.trim() || null,
        address: fields.address.value.trim() || null,
        contactPerson: fields.contact.value.trim() || null,
        cardImageUrl: imageUrl,
        owner: uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        ocrRaw: ocrText || null
      };
      await db.collection('companies').add(doc);

      saveMsg.innerHTML = '<span class="ok">Kaydedildi ✅</span>';
      Object.values(fields).forEach(i => i.value = "");
      rawText.textContent = "";
    } catch (e) {
      saveMsg.innerHTML = `<span class="err">Hata: ${e.message}</span>`;
    } finally {
      btnSave.disabled = false;
    }
  };

  /* -------- İlk açılışta overlay açık; destek yoksa fallback -------- */
  if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
    camLog.innerHTML = '<span class="warn">Tarayıcı kamera API’sını yerel olarak göstermiyor, fotoğraf yükleme moduna geçildi.</span>';
    useFileCaptureFallback();
  }
  </script>
</body>
</html>
