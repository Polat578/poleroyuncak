<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Poler Oyuncak — Kartvizit Tara</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root { --bg:#0b1220; --fg:#eaf2ff; --muted:#9fb3c8; --brand:#0ea5e9; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;gap:8px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}
    main{max-width:960px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    video,canvas,img{width:100%;border-radius:12px;background:#000}
    button{appearance:none;border:0;background:var(--brand);color:#001018;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.2)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.03);color:var(--fg)}
    textarea{min-height:92px;resize:vertical}
    .hint{color:var(--muted);font-size:13px}
    .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Poler Oyuncak • Kartvizit Tara</h1>
    <span class="hint">/buying</span>
  </header>

  <main>
    <div class="grid">
      <!-- Kamera & Çekim -->
      <section class="card">
        <h2 style="margin:0 0 8px 0">1) Kartviziti Tara</h2>
        <p class="hint" id="permHint">Kamera izni isteyeceğiz. Işık iyi olsun, kart kadrajı doldursun.</p>
        <div class="row">
          <button id="btnStart">Kamerayı Aç</button>
          <button id="btnCapture" class="ghost" disabled>Fotoğraf Çek</button>
          <button id="btnRetake" class="ghost" disabled>Tekrar Çek</button>
        </div>
        <div style="margin-top:10px">
          <video id="video" playsinline muted></video>
          <canvas id="canvas" style="display:none"></canvas>
          <img id="preview" alt="Önizleme" style="display:none"/>
          <!-- Fallback için gizli file input -->
          <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none" />
        </div>
        <p class="hint mono" id="camLog"></p>
      </section>

      <!-- Form & OCR -->
      <section class="card">
        <h2 style="margin:0 0 8px 0">2) Kontrol Et & Kaydet</h2>
        <p class="hint">OCR otomatik doldurur; gerekirse düzelt.</p>

        <div class="row" style="gap:12px">
          <div style="flex:1">
            <label for="name">Şirket Adı</label>
            <input id="name" placeholder="Örn: Poler Oyuncak A.Ş." />
          </div>
          <div style="width:240px;max-width:100%">
            <label for="phone">Telefon</label>
            <input id="phone" placeholder="+90 5xx xxx xx xx" />
          </div>
        </div>

        <div class="row" style="gap:12px;margin-top:8px">
          <div style="flex:1">
            <label for="email">E-posta</label>
            <input id="email" placeholder="info@..." />
          </div>
          <div style="flex:1">
            <label for="address">Adres</label>
            <input id="address" placeholder="Mah., Cad., No, İl/İlçe..." />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnOcr" class="ghost" disabled>OCR ile Doldur</button>
          <button id="btnSave" disabled>Kaydet</button>
          <span id="saveMsg" class="hint"></span>
        </div>

        <details style="margin-top:12px">
          <summary class="hint">OCR ham metni göster</summary>
          <pre id="rawText" class="mono" style="white-space:pre-wrap"></pre>
        </details>
      </section>
    </div>
  </main>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- Firebase (compat SDK'ler – vanilla JS için basit) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>

  <script>
  // --------- Firebase Config (senin uygulamandan) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD4MPM2fvkTXeOWG12g-wV_s3eG4SkBWS0",
    authDomain: "poleroyuncak.firebaseapp.com",
    projectId: "poleroyuncak",
    storageBucket: "poleroyuncak.appspot.com",
    messagingSenderId: "473844630811",
    appId: "1:473844630811:web:721ebd8a9b6f085da03fbe",
    measurementId: "G-JNQTNX3EC4"
  };
  // ---------------------------------------------------------

  let app, auth, db, storage, uid = null;
  try {
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    storage = firebase.storage();
    // Anonim login
    auth.onAuthStateChanged(async (u) => {
      if (!u) await auth.signInAnonymously();
      uid = (auth.currentUser || u).uid;
      document.getElementById('btnSave').disabled = false; // login tamam
    });
  } catch (e) {
    console.warn("Firebase init edilemedi (config girilmemiş olabilir):", e);
  }

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const preview = document.getElementById('preview');
  const fileInput = document.getElementById('fileInput');

  const btnStart = document.getElementById('btnStart');
  const btnCapture = document.getElementById('btnCapture');
  const btnRetake = document.getElementById('btnRetake');
  const btnOcr = document.getElementById('btnOcr');
  const btnSave = document.getElementById('btnSave');

  const camLog = document.getElementById('camLog');
  const rawText = document.getElementById('rawText');
  const saveMsg = document.getElementById('saveMsg');

  const $ = (id) => document.getElementById(id);
  const fields = { name: $('name'), phone: $('phone'), email: $('email'), address: $('address') };

  let stream = null, lastImageBlob = null, ocrText = "";

  // Fallback: Dosya girişi ile kamera/galeri açtırma (mobilde kamera uygulamasını tetikler)
  function useFileCaptureFallback(openPicker = false) {
    btnCapture.disabled = false;
    btnRetake.disabled = true;
    btnOcr.disabled = true;

    video.style.display = 'none';
    preview.style.display = 'none';

    fileInput.onchange = () => {
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        lastImageBlob = file;
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
        btnRetake.disabled = false;
        btnOcr.disabled = false;
        camLog.textContent = "Fotoğraf yüklendi. OCR için hazır.";
      }
    };

    if (openPicker) fileInput.click();
    else camLog.innerHTML += ' <span class="hint">(“Fotoğraf Çek”e basınca kamera/galeri açılır.)</span>';
  }

  // Kamerayı aç (getUserMedia + fallback)
  btnStart.onclick = async () => {
    try {
      if (location.protocol !== 'https:') {
        camLog.innerHTML = '<span class="err">HTTPS gerekli. Sayfayı https:// ile aç.</span>';
        return useFileCaptureFallback();
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        camLog.innerHTML = '<span class="warn">Tarayıcı kamera API’sını desteklemiyor, fotoğraf yükleme moduna geçildi.</span>';
        return useFileCaptureFallback();
      }
      // Instagram/TikTok/WhatsApp in-app browser’da sorun çıkabilir
      // Mümkünse Safari/Chrome’da açın.
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false
      });
      video.srcObject = stream;
      video.setAttribute('playsinline', 'true'); // iOS tam ekran yapmasın
      video.muted = true;
      await video.play();

      btnCapture.disabled = false;
      btnRetake.disabled = true;
      btnOcr.disabled = true;

      preview.style.display = 'none';
      canvas.style.display = 'none';
      video.style.display = 'block';
      camLog.textContent = "Kamera aktif.";
    } catch (err) {
      camLog.innerHTML = `Kamera açılamadı: <span class="err">${err.message||err.name||'hata'}</span> — fotoğraf yükleme moduna geçiliyor.`;
      useFileCaptureFallback();
    }
  };

  // Fotoğraf çek (fallback’te dosya seçtir)
  btnCapture.onclick = async () => {
    if (!stream || !video.videoWidth) return useFileCaptureFallback(true);

    const w = video.videoWidth, h = video.videoHeight;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    canvas.toBlob((blob) => {
      if (!blob) return;
      lastImageBlob = blob;
      preview.src = URL.createObjectURL(blob);
      preview.style.display = 'block';
      video.style.display = 'none';
      canvas.style.display = 'none';
      btnRetake.disabled = false;
      btnOcr.disabled = false;
      camLog.textContent = "Fotoğraf alındı. OCR için hazır.";
    }, 'image/jpeg', 0.92);
  };

  // Tekrar çek (her iki modda da)
  btnRetake.onclick = () => {
    preview.style.display = 'none';
    if (stream) {
      video.style.display = 'block';
      btnOcr.disabled = true;
      camLog.textContent = "Tekrar çekebilirsiniz.";
    } else {
      // Fallback modda tekrar dosya seçtir
      fileInput.value = '';
      lastImageBlob = null;
      btnOcr.disabled = true;
      camLog.textContent = "Tekrar fotoğraf seçebilirsiniz.";
    }
  };

  // Basit alan çıkarımı (TR ağırlıklı)
  function extractFields(text) {
    const email = (text.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)||[])[0]||"";
    const tel = (text.match(/(\+?90[\s\-]?)?0?\s?5\d{2}[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}|(\+?90[\s\-]?)?\(?\d{3}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}/)||[])[0]||"";
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const addrLine = lines.find(l => /mah\.|mh\.|cad\.|cd\.|sok\.|sk\.|no[:\s]|ilçe|istanbul|ankara|izmir|bursa|kocaeli|antalya|adana|konya|gaziantep|kayseri|mersin|eskişehir/i.test(l)) || "";
    const nameCand = lines.slice(0,5).find(l => !/\d/.test(l) && l.length<=32) || lines[0] || "";
    return { name: nameCand, phone: tel, email: email, address: addrLine };
  }

  // OCR çalıştır
  btnOcr.onclick = async () => {
    if (!lastImageBlob) return;
    btnOcr.disabled = true; btnOcr.textContent = "OCR çalışıyor...";
    try {
      const { data } = await Tesseract.recognize(lastImageBlob, 'tur+eng', {
        logger: m => { camLog.textContent = `OCR: ${m.status} ${Math.round((m.progress||0)*100)}%`; }
      });
      ocrText = (data.text || "").trim();
      rawText.textContent = ocrText || "(metin bulunamadı)";
      const info = extractFields(ocrText);
      fields.name.value = info.name;
      fields.phone.value = info.phone;
      fields.email.value = info.email;
      fields.address.value = info.address;
      btnSave.disabled = false;
      camLog.innerHTML = `OCR tamam: <span class="ok">alanlar dolduruldu</span>`;
    } catch (e) {
      camLog.innerHTML = `OCR hata: <span class="err">` + e.message + `</span>`;
    } finally {
      btnOcr.textContent = "OCR ile Doldur";
      btnOcr.disabled = false;
    }
  };

  // Kaydet → Firebase Storage + Firestore
  btnSave.onclick = async () => {
    if (!db || !storage || !uid) { saveMsg.innerHTML = '<span class="warn">Firebase yapılandır.</span>'; return; }
    if (!fields.name.value.trim()) { saveMsg.innerHTML = '<span class="warn">Şirket adı zorunlu.</span>'; return; }
    btnSave.disabled = true; saveMsg.textContent = "Kaydediliyor...";

    try {
      // 1) Foto yükle
      let imageUrl = null;
      if (lastImageBlob) {
        const key = `cards/${uid}/${crypto.randomUUID()}.jpg`;
        const ref = storage.ref().child(key);
        await ref.put(lastImageBlob, { contentType: 'image/jpeg' });
        imageUrl = await ref.getDownloadURL();
      }
      // 2) DB yaz
      const doc = {
        name: fields.name.value.trim(),
        phone: fields.phone.value.trim() || null,
        email: fields.email.value.trim() || null,
        address: fields.address.value.trim() || null,
        cardImageUrl: imageUrl,
        owner: uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        ocrRaw: ocrText || null
      };
      await db.collection('companies').add(doc);
      saveMsg.innerHTML = '<span class="ok">Kaydedildi ✅</span>';
      Object.values(fields).forEach(i => i.value = "");
      rawText.textContent = "";
    } catch (e) {
      saveMsg.innerHTML = `<span class="err">Hata: ${e.message}</span>`;
    } finally {
      btnSave.disabled = false;
    }
  };

  // Tarayıcı desteği kontrolü — gerekirse otomatik fallback
  if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
    camLog.innerHTML = '<span class="warn">Tarayıcı kamera API’sını yerel olarak göstermiyor, fotoğraf yükleme moduna geçildi.</span>';
    useFileCaptureFallback();
  }
  </script>
</body>
</html>
